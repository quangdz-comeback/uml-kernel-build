name: Build UML Kernel (Newest mainline kernel, NOT RECOMMENDED FOR PRODUCTION USES)

on:
  schedule:
      - cron: '0 12 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up the environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential libncurses-dev flex bison \
              libssl-dev libelf-dev bc dwarves wget curl tar xz-utils qemu-utils \
              systemd-container libglib2.0-dev libpcre2-dev pkg-config libpcre3-dev

      - name: Download Kernel Source
        run: |
          KVER=$(curl -s https://www.kernel.org/releases.json | jq -r '.releases[] | select(.moniker=="mainline") | .version' | sort -V | tail -n 1)
          KURL="https://git.kernel.org/torvalds/t/linux-${KVER}.tar.gz"
          echo "[+] Downloading kernel ${KVER}"
          wget -O linux.tar.gz "$KURL"
          tar -xf linux.tar.gz
          cd linux-${KVER}

      - name: Build UML kernel
        run: |
          KVER=$(curl -s https://www.kernel.org/releases.json | jq -r '.releases[] | select(.moniker=="mainline") | .version' | sort -V | tail -n 1)
          cd linux-${KVER}
          echo "[+] Configuring UML kernel..."
          make ARCH=um defconfig
          scripts/config --file .config \
              -e CONFIG_BLK_DEV \
              -e CONFIG_BLK_DEV_LOOP \
              -e CONFIG_BLK_DEV_UBD \
              -e CONFIG_EXT4_FS \
              -e CONFIG_EXT2_FS \
              -e CONFIG_EXT3_FS \
              -e CONFIG_FS_MBCACHE \
              -e CONFIG_NET \
              -e CONFIG_INET \
              -e CONFIG_PACKET \
              -e CONFIG_NETDEVICES \
              -e CONFIG_NET_CORE \
              -e CONFIG_TUN \
              -e CONFIG_SLHC \
              -e CONFIG_SLIP \
              -e CONFIG_SLIP_COMPRESSED \
              -e CONFIG_SLIP_SMART \
              -e CONFIG_SLIP_MODE_SLIP6 \
              -e CONFIG_UML_NET \
              -e CONFIG_UML_NET_SLIRP \
              -d CONFIG_UML_NET_DAEMON \
              -e CONFIG_TTY \
              -e CONFIG_UNIX98_PTYS \
              -e CONFIG_DEVPTS_MULTIPLE_INSTANCES \
              -e CONFIG_DEVTMPFS \
              -e CONFIG_DEVTMPFS_MOUNT \
              -e CONFIG_TMPFS \
              -e CONFIG_TMPFS_POSIX_ACL \
              -e CONFIG_TMPFS_XATTR \
              -e CONFIG_PROC_FS \
              -e CONFIG_SYSFS \
              -e CONFIG_FHANDLE \
              -e CONFIG_SIGNALFD \
              -e CONFIG_TIMERFD \
              -e CONFIG_EPOLL \
              -e CONFIG_EVENTFD \
              -e CONFIG_BLK_DEV_INITRD \
              -e CONFIG_OVERLAY_FS \
              -e CONFIG_CGROUPS \
              -e CONFIG_CGROUP_SCHED \
              -e CONFIG_NAMESPACES \
              -e CONFIG_UTS_NS \
              -e CONFIG_IPC_NS \
              -e CONFIG_PID_NS \
              -e CONFIG_NET_NS \
              -e CONFIG_DEVPTS_FS \
              -e CONFIG_PTY \
              -d CONFIG_AUDIT \
              -d CONFIG_AUTOFS_FS \
              -d CONFIG_AUTOFS4_FS \
              -e CONFIG_COMPAT \
              -e CONFIG_NETFILTER \
              -e CONFIG_NF_CONNTRACK \
              -e CONFIG_NF_CONNTRACK_IPV4 \
              -e CONFIG_NF_NAT \
              -e CONFIG_NF_NAT_IPV4 \
              -e CONFIG_IP_FORWARD \
              -e CONFIG_IP_MULTICAST \
              -e CONFIG_IP_ADVANCED_ROUTER \
              -e CONFIG_IKCONFIG \
              -e CONFIG_IKCONFIG_PROC \
              -e CONFIG_SMP \
              -e CONFIG_UML_SMP \
              --set-val CONFIG_NR_CPUS 16 \
              -e CONFIG_SCHED_SMT \
              -e CONFIG_SCHED_MC \
              -e CONFIG_SCHED_CORE \
              -e CONFIG_GENERIC_CLOCKEVENTS \
              -e CONFIG_GENERIC_CLOCKEVENTS_BROADCAST \
              -e CONFIG_GENERIC_TIME \
              -e CONFIG_GENERIC_TIME_VSYSCALL \
              -e CONFIG_HIGH_RES_TIMERS \
              -e CONFIG_PREEMPT \
              -e CONFIG_PREEMPT_COUNT \
              -e CONFIG_MUTEX_SPIN_ON_OWNER \
              -e CONFIG_RWSEM_SPIN_ON_OWNER \
              -e CONFIG_USE_GENERIC_SMP_HELPERS \
              -e CONFIG_GENERIC_IRQ_SHOW \
              -e CONFIG_IRQ_DOMAIN \
              -e CONFIG_SPARSE_IRQ \
              -e CONFIG_TREE_RCU \
              -e CONFIG_PREEMPT_RCU \
              -e CONFIG_RCU_EXPERT \
              -e CONFIG_FLATMEM \
              -e CONFIG_FLATMEM_MANUAL \
              -e CONFIG_HAVE_MEMBLOCK \
              -e CONFIG_ARCH_KEEP_MEMBLOCK \
              -e CONFIG_MODE_SKAS \
              -e CONFIG_UML \
              -e CONFIG_MODE_TT
              
          make ARCH=um olddefconfig

          echo "[+] Building UML kernel (this may take ~5â€“15 min)"
          make ARCH=um \
              HOSTCC=gcc \
              CC=gcc \
              KCFLAGS="-static  -lglib-2.0 -lpcre -lm -fno-pie" \
              LDFLAGS="-static -lglib-2.0 -lpcre -lm -Wl,--no-dynamic-linker" \
              -j"$(nproc)"

      - name: Strip the kernel
        run: |
          KVER=$(curl -s https://www.kernel.org/releases.json | jq -r '.releases[] | select(.moniker=="mainline") | .version' | sort -V | tail -n 1)
          cp linux-${KVER}/linux ./linux
          strip ./linux

      - name: Upload Kernel artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: linux-uml
          path: ./linux
